# BC Radio Caddy Configuration
# Replace yourdomain.com with your actual domain

yourdomain.com {
	# Main site - serve static files (BC Radio frontend)
	handle / {
		file_server
		root * /var/www/bc-radio
	}
	
	# AzuraCast admin interface - proxy to AzuraCast web interface
	handle /admin* {
		reverse_proxy localhost:8080 {
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
	
	# AzuraCast public pages (if needed)
	handle /public* {
		reverse_proxy localhost:8080 {
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
	
	# API endpoints - proxy to AzuraCast API
	handle /api* {
		reverse_proxy localhost:8000 {
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
	
	# CORS headers for API
	@api path /api*
	header @api {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}
	
	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy strict-origin-when-cross-origin
	}
	
	# Gzip compression
	encode gzip
	
	# Logging
	log {
		output file /var/log/caddy/bc-radio.log
		format json
	}
}

# Stream subdomain - dedicated for streaming
stream.yourdomain.com {
	# Stream endpoints - proxy to AzuraCast streaming
	handle /* {
		reverse_proxy localhost:8000 {
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
	
	# CORS headers for streaming
	header {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Range"
		Access-Control-Expose-Headers "Content-Length, Content-Range"
	}
	
	# Streaming optimizations
	header {
		Cache-Control "no-cache, no-store, must-revalidate"
		Pragma "no-cache"
		Expires "0"
	}
	
	# Logging for stream access
	log {
		output file /var/log/caddy/bc-radio-stream.log
		format json
	}
}

# Development configuration (localhost)
localhost, localhost:3000 {
	handle / {
		file_server
		root * ./dist
	}
	
	handle /admin* {
		reverse_proxy localhost:8080
	}
	
	handle /public* {
		reverse_proxy localhost:8080
	}
	
	handle /api* {
		reverse_proxy localhost:8000
	}
	
	@api path /api*
	header @api {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}
}

# Development stream subdomain
stream.localhost {
	handle /* {
		reverse_proxy localhost:8000
	}
	
	header {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Range"
	}
}