<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BC Radio</title>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="SplitText.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BernieFM">
  <link rel="apple-touch-icon" href="appleicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>

  <style>
    :root {
      --bg: #f0f2f5;
      --card-bg: #ffffff;
      --text-main: #1c1e21;
      --text-secondary: #65676b;
      --border-light: #e4e6eb;
      --accent: #1877f2;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Instrument Sans', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    #player {
      position: relative;
      display: flex;
      flex-direction: row;
      max-width: 900px;
      width: 100%;
      margin: auto;
      padding: 40px;
      padding-top: 100px; /* Added padding for top elements */
      padding-bottom: 60px;
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,.1);
      background-color: var(--card-bg);
      text-align: left;
    }
    .left-column { 
      flex: 0 0 250px; 
      text-align: center; 
      padding-right: 40px; 
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .right-column { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      justify-content: center;
      position: relative;
    }
    #cd-case {
      perspective: 1200px;
      margin-bottom: 20px;
    }
    #album-art {
      width: 250px;
      height: 250px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 10px 25px rgba(0,0,0,.2);
      transition: transform 0.8s;
      transform-style: preserve-3d;
      transform: rotateY(-10deg) rotateX(2deg);
    }
    #cd-case:hover #album-art {
      transform: rotateY(0deg) rotateX(0deg);
    }
    #track-title {
      font-size: 1.7em;
      font-weight: 700;
      margin: 0 0 5px 0;
      line-height: 1.1;
      display: inline-block;
    }
    #unreleased-tag {
        display: none;
        background: linear-gradient(to right, #b388ff, #ff80ab, #40c4ff);
        color: white;
        padding: 4px 9px;
        border-radius: 7px;
        font-size: 0.5em;
        font-weight: 700;
        margin-left: 12px;
        vertical-align: middle;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    #artist-name {
      font-size: 1em;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 25px;
    }
    #upcoming { 
        font-size: 1em; 
        color: var(--text-secondary); 
        margin-bottom: 25px;
        line-height: 1.5;
    }
    #upcoming strong { color: var(--text-main); font-weight: 600; }
    #upcoming .song-item { margin-top: 4px; }
    #upcoming .song-title { color: var(--text-main); }
    #upcoming .song-album { font-size: 0.9em; }

    /* Play Button & Progress */
    #play-pause-btn {
    display: inline-block;
    align-items: center;
    background: #fff;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    font-size: 1em;
    font-weight: 600;
    color: var(--text-main);
    cursor: pointer;
    padding: 12px 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease-in-out;
    width: 200px;
}

    #play-pause-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 7px 14px rgba(0,0,0,0.07), 0 3px 6px rgba(0,0,0,0.05);
    }
    #play-pause-btn i { margin-right: 10px; }

    #stream-duration-container {
        margin-bottom: 20px;
        font-weight: 600;
        color: var(--text-secondary);
    }

    /* Weather & Time */
    #current-time, #current-weather {
        position: absolute;
        top: 20px;
        font-size: 13px;
        font-weight: 600;
        background: var(--bg);
        padding: 5px 10px;
        border-radius: 8px;
        line-height: 1.3;
    }
    #current-time { left: 35px; text-align: right; }
    #current-weather { right: 20px; }
    .tick-time { font-size: 1.2em; }
    
    .social-links { margin-top: 25px; font-size: 24px; display: flex; gap: 20px; justify-content: center; }
    .social-links a { color: var(--text-secondary); transition: color .2s; }
    .social-links a:hover { color: var(--accent); }

    /* Live Indicator */
    #live-indicator {
       position: absolute;
       top: -30px;
       right: 0;
       background: #fa383e;
       color: white;
       padding: 4px 10px;
       border-radius: 6px;
       font-size: 0.8em;
       font-weight: 700;
       display: flex;
       align-items: center;
       gap: 5px;
     }
     #live-indicator span {
       width: 8px;
       height: 8px;
       background: white;
       border-radius: 50%;
       animation: blink 1.5s infinite ease-in-out;
     }
     @keyframes blink {
       0%, 100% { opacity: 1; }
       50% { opacity: 0.3; }
     }

    @media (max-width: 1200px) {
      body {
        padding: 20px;
      }
      #player {
        flex-direction: column;
        margin: 0;
        width: 100%;
        padding: 30px;
        padding-top: 80px;
      }    
      .left-column {
        padding-right: 0;
        padding-bottom: 30px;
        align-items: center;
      }
      .right-column {
        align-items: center;
        text-align: center;
      }
      #live-indicator {
        position: static;
        transform: none;
        margin-bottom: 20px;
      }
      #album-art {
        width: 180px;
        height: 180px;
        transform: none; /* Disable 3D effect on mobile */
      }
      #track-title {
        font-size: 1.3em;
      }
    }

  </style>
</head>
<body>

  <div id="player">
    <span id="current-time"></span>
    <span id="current-weather">Loading...</span>

    <div class="left-column">
      <div id="cd-case">
        <img id="album-art" src="" alt="Album Art">
      </div>
      <div class="social-links">
        <a href="https://open.spotify.com/artist/3Y6PS22sOf1n12v2qTu2Fm" target="_blank" aria-label="Spotify"><i class="fab fa-spotify"></i></a>
        <a href="https://www.facebook.com/bernie.chiaravalle/" target="_blank" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
        <a href="https://www.instagram.com/berniechiaravalle/" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://berniechiaravalle.com/" target="_blank" aria-label="Official Website"><i class="fas fa-link"></i></a>
      </div>
    </div>

    <div class="right-column">
      <div id="live-indicator"><span></span>LIVE</div>
      <div>
        <h1 id="track-title">Welcome to BC Radio</h1>
        <span id="unreleased-tag">Unreleased</span>
      </div>
      <p id="artist-name">Music is loading...</p>
      <button id="play-pause-btn" style="margin-bottom: 15px;">
        <i id="btn-icon" class="fa-solid fa-play"></i>
        <span id="play-label">Play</span>
    </button>
      <div id="upcoming">
        <strong>On Deck</strong>
        <div id="upcoming-list">Loading...</div>
      </div>
      <div id="stream-duration-container">
          <span id="stream-duration">00:00:00</span>
      </div>
      
    </div>
  </div>
  
  <audio id="audio-stream" src="http://localhost:8000/stream" preload="metadata"></audio>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      AOS.init();
      const audio = document.getElementById('audio-stream');
      const playBtn = document.getElementById('play-pause-btn');
      const playLabel = document.getElementById('play-label');
      const playIcon = document.getElementById('btn-icon');
      const titleEl = document.getElementById('track-title');
      const artistEl = document.getElementById('artist-name');
      const albumArtEl = document.getElementById('album-art');
      const upcomingListEl = document.getElementById('upcoming-list');
      const streamDurationEl = document.getElementById('stream-duration');
      const unreleasedTag = document.getElementById('unreleased-tag');
      
      let isPlaying = false;
      let streamSeconds = 0;
      let streamInterval = null;

      // --- Audio Controls ---
      const togglePlay = () => {
        if (isPlaying) {
          audio.pause();
        } else {
          // The stream is continuous, so we just want to start playing it.
          // We might need to reload it if it has been paused for a long time.
          audio.load(); // Reload to get the latest part of the stream
          audio.play().catch(e => console.error("Error playing audio:", e));
        }
      };

      playBtn.addEventListener('click', togglePlay);
      
      audio.addEventListener('play', () => {
        isPlaying = true;
        playLabel.textContent = 'Pause';
        playIcon.className = 'fa-solid fa-pause';
        if (!streamInterval) {
            streamInterval = setInterval(updateStreamDuration, 1000);
        }
      });

      audio.addEventListener('pause', () => {
        isPlaying = false;
        playLabel.textContent = 'Play';
        playIcon.className = 'fa-solid fa-play';
        clearInterval(streamInterval);
        streamInterval = null;
      });
      
      // --- Playlist Fetching and UI Update ---
      async function fetchAndUpdatePlaylist() {
        try {
          const response = await fetch('http://localhost:8001/playlist');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          updateUI(data);
        } catch (error) {
          console.error("Could not fetch playlist:", error);
          titleEl.textContent = "Stream Offline";
          artistEl.textContent = "Please wait, attempting to reconnect...";
        }
      }

      function updateUI(data) {
        const { now_playing, upcoming } = data;
        
        upcomingListEl.innerHTML = ''; // Clear existing list to prevent duplicates

        titleEl.textContent = now_playing.title;
        artistEl.textContent = now_playing.artist;

        if (now_playing.unreleased) {
          unreleasedTag.style.display = 'inline-block';
        } else {
          unreleasedTag.style.display = 'none';
        }
        
        if (albumArtEl.src !== now_playing.album_art_url) {
            albumArtEl.src = now_playing.album_art_url || '';
        }

        let upcomingHTML = '';
        upcoming.forEach(song => {
          upcomingHTML += `<div class="song-item">
                             <div class="song-title">${song.title}</div>
                             <div class="song-album">${song.album}</div>
                           </div>`;
        });
        upcomingListEl.innerHTML = upcomingHTML;
      }

      // --- Clock ---
      const timeSpan = document.getElementById('current-time');
      function updateTime() {
          const now = new Date();
          const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const day = days[now.getDay()];
          const date = now.getDate();
          const month = months[now.getMonth()];
          let hours = now.getHours();
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const ampm = hours >= 12 ? 'p' : 'a';
          hours = hours % 12;
          hours = hours ? hours : 12;
          timeSpan.innerHTML = `<span class="tick-time">${hours}:${minutes}${ampm}</span><br><span class="tick-date">${day} ${month} ${date}</span>`;
      }

      // --- Stream Duration Counter ---
      function formatDuration(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return [hours, minutes, seconds]
            .map(v => String(v).padStart(2, '0'))
            .join(':');
      }

      function updateStreamDuration() {
          streamSeconds++;
          streamDurationEl.textContent = formatDuration(streamSeconds);
      }

      // --- Weather ---
      async function fetchWeather() {
          try {
              const ipInfo = await fetch('https://ipapi.co/json/').then(r => r.json());
              const { city, latitude, longitude } = ipInfo;
              const weatherInfo = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=fahrenheit`).then(r => r.json());
              const { temperature, weathercode } = weatherInfo.current_weather;
              const temp = Math.round(temperature);
              
              const weatherSpan = document.getElementById('current-weather');
              let iconClass = "fa-cog"; // Default to a settings-like icon
              if (weathercode === 0) iconClass = "fa-sun";
              if (weathercode > 0 && weathercode < 4) iconClass = "fa-cloud-sun";
              if (weathercode >= 51 && weathercode <= 67) iconClass = "fa-cloud-rain";
              if (weathercode >= 71 && weathercode <= 77) iconClass = "fa-snowflake";
              if (weathercode >= 95) iconClass = "fa-bolt";

              weatherSpan.innerHTML = `<i class="fas ${iconClass}" style="margin-right:8px;"></i> ${city}, ${temp}°F`;
          } catch (error) {
              console.error('Weather fetch error:', error);
              document.getElementById('current-weather').innerHTML = `<i class="fas fa-triangle-exclamation"></i> Weather unavailable`;
          }
      }
      
      // --- Init and Intervals ---
      audio.load();
      fetchAndUpdatePlaylist();
      setInterval(fetchAndUpdatePlaylist, 5000);
      updateTime();
      setInterval(updateTime, 30000);
      fetchWeather();
      setInterval(fetchWeather, 1000 * 60 * 15);

    });
  </script>

<style>
  @media screen and (max-width: 1200px) {
    #album-art, #cd-case {
    width: 100%!important;
        height: auto!important;
        aspect-ratio: 1/1!important;
        max-width: unset!important;
        margin-top: 10px;
        border-radius: 5px

}
    
    
    #current-time {
        left: 30px;
        text-align: left
    }
    
    #current-weather {
        right: 30px;
        top: 30px
    }
}
    
    #upcoming-list {
/*         background-color: #e6e6e6; */
        padding: 25px 25px;
        margin-top: 10px;
        border-radius: 5px;
        box-shadow: rgba(50, 50, 93, 0.25) 0px 10px 25px -12px inset, rgba(0, 0, 0, 0.3) 0px 8px 14px -8px inset;
       }


.song-album {
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 2px;
    font-size: 10px!important;
    margin-bottom: 10px
}

#artist-name {
    font-size: 10px!important;
    margin: 0;
    margin-bottom: 25px;
}
</style>
</body>
</html>